<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å®¶æ—ãƒ„ãƒ¼ãƒ« - Family Tool</title>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', sans-serif;
      background: #f5f5f5;
      padding-bottom: 80px;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      text-align: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .header h1 {
      font-size: 24px;
      margin-bottom: 10px;
    }

    .user-info {
      font-size: 14px;
      opacity: 0.9;
    }

    .points-badge {
      display: inline-block;
      background: rgba(255,255,255,0.2);
      padding: 5px 15px;
      border-radius: 20px;
      margin-top: 10px;
      font-weight: bold;
    }

    .tabs {
      display: flex;
      background: white;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .tab {
      flex: 1;
      padding: 15px;
      text-align: center;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: all 0.3s;
    }

    .tab.active {
      border-bottom-color: #667eea;
      color: #667eea;
      font-weight: bold;
    }

    .tab-content {
      display: none;
      padding: 20px;
    }

    .tab-content.active {
      display: block;
    }

    .task-card, .template-card {
      background: white;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 15px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .task-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 10px;
    }

    .task-title {
      font-size: 18px;
      font-weight: bold;
      color: #333;
    }

    .task-status {
      padding: 4px 12px;
      border-radius: 15px;
      font-size: 12px;
      font-weight: bold;
    }

    .status-pending {
      background: #ffeaa7;
      color: #d63031;
    }

    .status-in_progress {
      background: #74b9ff;
      color: #0984e3;
    }

    .status-completed {
      background: #55efc4;
      color: #00b894;
    }

    .task-meta {
      font-size: 13px;
      color: #666;
      margin: 8px 0;
    }

    .task-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    button {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
      transition: all 0.3s;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-success {
      background: #00b894;
      color: white;
    }

    .btn-thanks {
      background: #fd79a8;
      color: white;
    }

    .btn-download {
      background: #74b9ff;
      color: white;
    }

    button:active {
      transform: scale(0.95);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #333;
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.3s;
    }

    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      outline: none;
      border-color: #667eea;
    }

    .form-group textarea {
      resize: vertical;
      min-height: 80px;
    }

    .fab {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-size: 24px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: transform 0.3s;
    }

    .fab:active {
      transform: scale(0.9);
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 100;
      align-items: center;
      justify-content: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 15px;
      padding: 25px;
      width: 90%;
      max-width: 500px;
      max-height: 80vh;
      overflow-y: auto;
    }

    .modal-header {
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 20px;
      color: #333;
    }

    .modal-close {
      float: right;
      font-size: 28px;
      cursor: pointer;
      color: #999;
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #999;
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 15px;
    }

    .day-badge {
      display: inline-block;
      padding: 4px 10px;
      background: #667eea;
      color: white;
      border-radius: 12px;
      font-size: 12px;
      margin-right: 8px;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #999;
    }
  </style>
</head>
<body>
  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <div class="header">
    <h1>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ å®¶æ—ãƒ„ãƒ¼ãƒ«</h1>
    <div class="user-info" id="userInfo">èª­ã¿è¾¼ã¿ä¸­...</div>
    <div class="points-badge" id="pointsBadge">â­ 0 ãƒã‚¤ãƒ³ãƒˆ</div>
  </div>

  <!-- ã‚¿ãƒ– -->
  <div class="tabs">
    <div class="tab active" onclick="switchTab('tasks')">ğŸ“‹ ã‚¿ã‚¹ã‚¯</div>
    <div class="tab" onclick="switchTab('schedules')">ğŸ“… äºˆå®š</div>
  </div>

  <!-- ã‚¿ã‚¹ã‚¯ã‚¿ãƒ– -->
  <div id="tasks-content" class="tab-content active">
    <div id="tasksList"></div>
    <div class="fab" onclick="openTaskModal()">+</div>
  </div>

  <!-- äºˆå®šã‚¿ãƒ– -->
  <div id="schedules-content" class="tab-content">
    <div id="schedulesList"></div>
    <div class="fab" onclick="openScheduleModal()">+</div>
  </div>

  <!-- ã‚¿ã‚¹ã‚¯ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="taskModal" class="modal">
    <div class="modal-content">
      <span class="modal-close" onclick="closeTaskModal()">&times;</span>
      <div class="modal-header">æ–°ã—ã„ã‚¿ã‚¹ã‚¯</div>
      <form id="taskForm" onsubmit="createTask(event)">
        <div class="form-group">
          <label>ã‚¿ã‚¤ãƒˆãƒ« *</label>
          <input type="text" id="taskTitle" required>
        </div>
        <div class="form-group">
          <label>èª¬æ˜</label>
          <textarea id="taskDescription"></textarea>
        </div>
        <button type="submit" class="btn-primary" style="width: 100%;">ä½œæˆ</button>
      </form>
    </div>
  </div>

  <!-- äºˆå®šãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="scheduleModal" class="modal">
    <div class="modal-content">
      <span class="modal-close" onclick="closeScheduleModal()">&times;</span>
      <div class="modal-header">äºˆå®šãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</div>
      <form id="scheduleForm" onsubmit="createSchedule(event)">
        <div class="form-group">
          <label>ã‚¿ã‚¤ãƒˆãƒ« *</label>
          <input type="text" id="scheduleTitle" required>
        </div>
        <div class="form-group">
          <label>èª¬æ˜</label>
          <textarea id="scheduleDescription"></textarea>
        </div>
        <div class="form-group">
          <label>æ›œæ—¥ *</label>
          <select id="scheduleDayOfWeek" required>
            <option value="0">æ—¥æ›œæ—¥</option>
            <option value="1">æœˆæ›œæ—¥</option>
            <option value="2">ç«æ›œæ—¥</option>
            <option value="3">æ°´æ›œæ—¥</option>
            <option value="4">æœ¨æ›œæ—¥</option>
            <option value="5">é‡‘æ›œæ—¥</option>
            <option value="6">åœŸæ›œæ—¥</option>
          </select>
        </div>
        <div class="form-group">
          <label>æ™‚é–“ *</label>
          <input type="time" id="scheduleTimeSlot" required>
        </div>
        <button type="submit" class="btn-primary" style="width: 100%;">ä½œæˆ</button>
      </form>
    </div>
  </div>

  <script>
    const API_BASE = window.location.origin;
    let currentUser = null;
    let currentGroup = null;
    const DAYS = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];

    // LIFFåˆæœŸåŒ–
    async function initializeLiff() {
      try {
        await liff.init({ liffId: '2006620056-LnDYw78o' }); // å®Ÿéš›ã®LIFF IDã«ç½®ãæ›ãˆ

        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }

        const profile = await liff.getProfile();
        const context = liff.getContext();

        // ã‚°ãƒ«ãƒ¼ãƒ—IDã‚’å–å¾—ï¼ˆã‚°ãƒ«ãƒ¼ãƒ—ãƒˆãƒ¼ã‚¯å†…ã®å ´åˆï¼‰
        const groupId = context?.groupId || context?.roomId || 'default';

        // ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆãƒ»å–å¾—
        const groupResponse = await fetch(`${API_BASE}/api/groups`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            lineGroupId: groupId,
            name: context?.type === 'group' ? 'ã‚°ãƒ«ãƒ¼ãƒ—' : 'å€‹äºº'
          })
        });
        currentGroup = await groupResponse.json();

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—ã¾ãŸã¯ä½œæˆ
        const userResponse = await fetch(
          `${API_BASE}/api/users/by-line-id?lineUserId=${profile.userId}&groupId=${currentGroup.id}`
        );
        currentUser = await userResponse.json();

        if (!currentUser) {
          currentUser = {
            lineUserId: profile.userId,
            displayName: profile.displayName,
            groupId: currentGroup.id,
            points: 0
          };
        }

        // UIæ›´æ–°
        document.getElementById('userInfo').textContent = `${profile.displayName}`;
        updatePoints();

        // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        loadTasks();
        loadSchedules();
      } catch (error) {
        console.error('LIFF initialization failed:', error);
        // ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ï¼ˆé–‹ç™ºç”¨ï¼‰
        currentGroup = { id: 1, line_group_id: 'demo', name: 'ãƒ‡ãƒ¢ã‚°ãƒ«ãƒ¼ãƒ—' };
        currentUser = {
          id: 1,
          lineUserId: 'demo-user',
          displayName: 'ãƒ‡ãƒ¢ãƒ¦ãƒ¼ã‚¶ãƒ¼',
          groupId: 1,
          points: 0
        };
        document.getElementById('userInfo').textContent = 'ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰';
        loadTasks();
        loadSchedules();
      }
    }

    // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
    function switchTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

      event.target.classList.add('active');
      document.getElementById(`${tab}-content`).classList.add('active');
    }

    // ã‚¿ã‚¹ã‚¯ä¸€è¦§èª­ã¿è¾¼ã¿
    async function loadTasks() {
      const container = document.getElementById('tasksList');
      container.innerHTML = '<div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>';

      try {
        const response = await fetch(`${API_BASE}/api/tasks?groupId=${currentGroup.id}`);
        const tasks = await response.json();

        if (tasks.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">ğŸ“</div>
              <div>ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“</div>
              <div style="font-size: 14px; margin-top: 10px;">+ ãƒœã‚¿ãƒ³ã§ã‚¿ã‚¹ã‚¯ã‚’ä½œæˆã—ã¾ã—ã‚‡ã†</div>
            </div>
          `;
          return;
        }

        container.innerHTML = tasks.map(task => {
          const createdDate = new Date(task.created_at).toLocaleString('ja-JP');
          const executedDate = task.executed_at ? new Date(task.executed_at).toLocaleString('ja-JP') : null;
          const thankedDate = task.thanked_at ? new Date(task.thanked_at).toLocaleString('ja-JP') : null;

          return `
            <div class="task-card">
              <div class="task-header">
                <div class="task-title">${task.title}</div>
                <span class="task-status status-${task.status}">
                  ${task.status === 'pending' ? 'æœªç€æ‰‹' : task.status === 'in_progress' ? 'é€²è¡Œä¸­' : 'å®Œäº†'}
                </span>
              </div>
              ${task.description ? `<div style="color: #666; margin: 8px 0;">${task.description}</div>` : ''}
              <div class="task-meta">
                ğŸ‘¤ ä½œæˆ: ${task.creator_name} (${createdDate})
              </div>
              ${executedDate ? `
                <div class="task-meta">
                  âœ… å®Ÿè¡Œ: ${task.executor_name} (${executedDate})
                </div>
              ` : ''}
              ${thankedDate ? `
                <div class="task-meta">
                  ğŸ’ ã‚ã‚ŠãŒã¨ã†: ${task.thanked_name} (${thankedDate})
                </div>
              ` : ''}
              <div class="task-actions">
                ${task.status === 'pending' ? `
                  <button class="btn-success" onclick="executeTask(${task.id})">å®Ÿè¡Œã™ã‚‹</button>
                ` : ''}
                ${task.status === 'in_progress' && !task.thanked_at ? `
                  <button class="btn-thanks" onclick="thankTask(${task.id})">ã‚ã‚ŠãŒã¨ã† ğŸ’</button>
                ` : ''}
              </div>
            </div>
          `;
        }).join('');
      } catch (error) {
        console.error('Failed to load tasks:', error);
        container.innerHTML = '<div class="empty-state">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</div>';
      }
    }

    // ã‚¿ã‚¹ã‚¯ä½œæˆ
    async function createTask(event) {
      event.preventDefault();

      const title = document.getElementById('taskTitle').value;
      const description = document.getElementById('taskDescription').value;

      try {
        await fetch(`${API_BASE}/api/tasks`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            groupId: currentGroup.id,
            title,
            description,
            lineUserId: currentUser.lineUserId,
            displayName: currentUser.displayName
          })
        });

        closeTaskModal();
        loadTasks();
      } catch (error) {
        console.error('Failed to create task:', error);
        alert('ã‚¿ã‚¹ã‚¯ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    // ã‚¿ã‚¹ã‚¯å®Ÿè¡Œ
    async function executeTask(taskId) {
      try {
        await fetch(`${API_BASE}/api/tasks/${taskId}/execute`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            lineUserId: currentUser.lineUserId,
            displayName: currentUser.displayName,
            groupId: currentGroup.id
          })
        });

        loadTasks();
      } catch (error) {
        console.error('Failed to execute task:', error);
        alert('ã‚¿ã‚¹ã‚¯ã®å®Ÿè¡Œã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    // ã‚ã‚ŠãŒã¨ã†
    async function thankTask(taskId) {
      try {
        await fetch(`${API_BASE}/api/tasks/${taskId}/thank`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            lineUserId: currentUser.lineUserId,
            displayName: currentUser.displayName,
            groupId: currentGroup.id
          })
        });

        loadTasks();
        updatePoints();
      } catch (error) {
        console.error('Failed to thank task:', error);
        alert('ã‚ã‚ŠãŒã¨ã†ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    // äºˆå®šãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¸€è¦§èª­ã¿è¾¼ã¿
    async function loadSchedules() {
      const container = document.getElementById('schedulesList');
      container.innerHTML = '<div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>';

      try {
        const response = await fetch(`${API_BASE}/api/schedule-templates?groupId=${currentGroup.id}`);
        const schedules = await response.json();

        if (schedules.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">ğŸ“…</div>
              <div>äºˆå®šãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</div>
              <div style="font-size: 14px; margin-top: 10px;">+ ãƒœã‚¿ãƒ³ã§ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½œæˆã—ã¾ã—ã‚‡ã†</div>
            </div>
          `;
          return;
        }

        container.innerHTML = schedules.map(schedule => `
          <div class="template-card">
            <div class="task-header">
              <div class="task-title">${schedule.title}</div>
              <span class="day-badge">${DAYS[schedule.day_of_week]}æ›œ</span>
            </div>
            ${schedule.description ? `<div style="color: #666; margin: 8px 0;">${schedule.description}</div>` : ''}
            <div class="task-meta">ğŸ• ${schedule.time_slot}</div>
            <div class="task-actions">
              <button class="btn-download" onclick="downloadICS(${schedule.id}, '${schedule.title}')">
                ğŸ“¥ ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«è¿½åŠ 
              </button>
            </div>
          </div>
        `).join('');
      } catch (error) {
        console.error('Failed to load schedules:', error);
        container.innerHTML = '<div class="empty-state">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</div>';
      }
    }

    // äºˆå®šãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä½œæˆ
    async function createSchedule(event) {
      event.preventDefault();

      const title = document.getElementById('scheduleTitle').value;
      const description = document.getElementById('scheduleDescription').value;
      const dayOfWeek = document.getElementById('scheduleDayOfWeek').value;
      const timeSlot = document.getElementById('scheduleTimeSlot').value;

      try {
        await fetch(`${API_BASE}/api/schedule-templates`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            groupId: currentGroup.id,
            title,
            description,
            dayOfWeek: parseInt(dayOfWeek),
            timeSlot
          })
        });

        closeScheduleModal();
        loadSchedules();
      } catch (error) {
        console.error('Failed to create schedule:', error);
        alert('äºˆå®šãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    // iCalendarãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
    async function downloadICS(templateId, title) {
      try {
        const today = new Date().toISOString().split('T')[0];
        const response = await fetch(`${API_BASE}/api/schedule-templates/${templateId}/ics?date=${today}`);
        const blob = await response.blob();

        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${title}.ics`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
      } catch (error) {
        console.error('Failed to download ICS:', error);
        alert('ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    // ãƒã‚¤ãƒ³ãƒˆæ›´æ–°
    async function updatePoints() {
      if (!currentUser || !currentUser.id) return;

      try {
        const response = await fetch(`${API_BASE}/api/users/${currentUser.id}/points`);
        const data = await response.json();
        document.getElementById('pointsBadge').textContent = `â­ ${data.points || 0} ãƒã‚¤ãƒ³ãƒˆ`;
      } catch (error) {
        console.error('Failed to update points:', error);
      }
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«åˆ¶å¾¡
    function openTaskModal() {
      document.getElementById('taskModal').classList.add('active');
      document.getElementById('taskForm').reset();
    }

    function closeTaskModal() {
      document.getElementById('taskModal').classList.remove('active');
    }

    function openScheduleModal() {
      document.getElementById('scheduleModal').classList.add('active');
      document.getElementById('scheduleForm').reset();
    }

    function closeScheduleModal() {
      document.getElementById('scheduleModal').classList.remove('active');
    }

    // åˆæœŸåŒ–
    initializeLiff();
  </script>
</body>
</html>
